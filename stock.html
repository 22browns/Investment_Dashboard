<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <title>Investment Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
</head>

<body onload='pageLoad()'>
    <script>
        var key = sessionStorage.getItem('key');
        var func = 'TIME_SERIES_INTRADAY';
        var symbol = sessionStorage.getItem('symbol');
        var interval;
        var priceLow = [];
        var priceHigh = [];
        let priceTarget = [];
        var XValues = [];
        var priceChart;
        var chartTitle;

        async function getData(newUrl) {
            url = newUrl;
            const response = await fetch(newUrl);
            var data = await response.json();
            return data;
        }
        function traverseData(dataset) {
            priceLow = [];
            priceHigh = [];
            XValues = [];
            var count = 1;
            for (let info in dataset) {
                if (info.includes('Time Series')) {
                    dataset = dataset[info];
                    break;
                }
            }
            for (let key in dataset) {
                if (func == 'TIME_SERIES_INTRADAY') {
                    XValues.unshift(key.split(" ")[1]);
                    if (interval == '1min' && count == 61) {
                        chartTitle = "Price Highs and Lows Over Last 60 Minutes"
                        break;
                    }
                    if (interval == '5min' && count == 61) {
                        chartTitle = "Price Highs and Lows Over Last 2 Hours"
                        break;
                    }
                    if (interval == '15min' && count == 49) {
                        chartTitle = "Price Highs and Lows Over Last 12 Hours"
                        break;
                    }
                    if (interval == '30min' && count == 49) {
                        chartTitle = "Price Highs and Lows Over Last 24 Hours"
                        break;
                    }
                    if (interval == '60min' && count == 49) {
                        chartTitle = "Price Highs and Lows Over Last 48 Hours"
                        break;
                    }
                }
                else {
                    XValues.push(key);
                    if (interval == 'daily' && count == 31) {
                        chartTitle = "Price Highs and Lows Over Last 30 Days"
                        break;
                    }
                    if (interval == 'weekly' && count == 25) {
                        chartTitle = "Price Highs and Lows Over Last 24 Weeks"
                        break;
                    }
                    if (interval == 'monthly' && count == 13) {
                        chartTitle = "Price Highs and Lows Over Last 12 Months"
                        break;
                    }
                }
                priceHigh.unshift(dataset[key]["2. high"]);
                priceLow.unshift(dataset[key]["3. low"]);
                priceTarget.unshift(476);
                count++;
            }
        }

        function createPriceChart() {
            var priceContext = document.getElementById("priceChart").getContext("2d");
            priceChart = new Chart(priceContext, {
                type: "line",
                data: {
                    labels: XValues,
                    datasets: [{
                        label: "Price Target",
                        data: priceTarget,
                        borderColor: "Green",
                        fill: false
                    },{
                        label: "Price High",
                        data: priceHigh,
                        borderColor: "red",
                        fill: false
                    }, {
                        label: "Price Low",
                        data: priceLow,
                        borderColor: "blue",
                        fill: false
                    }]
                },
                options: {
                    interaction: {
                        intersect: false,
                        mode: 'index',
                    },
                    responsive: true,
                    legend: { display: true },
                    plugins: {
                        title: {
                            display: true,
                            text: chartTitle
                        },
                    }
                }
            });
        }

        async function Main() {
            var dataset = await getData(url);
            traverseData(dataset);
            if (priceChart) {
                priceChart.destroy();
            }
            createPriceChart();

        }

        function changeInterval(newInterval) {
            interval = newInterval;
            if (interval != 'daily' && interval != 'weekly' && interval != 'monthly') {
                func = 'TIME_SERIES_INTRADAY';
                url = `https://www.alphavantage.co/query?function=${func}&symbol=${symbol}&interval=${interval}&apikey=${key}`;
            }
            else {
                var upperCaseInterval = interval.toUpperCase();
                func = `TIME_SERIES_${upperCaseInterval}_ADJUSTED`;
                url = `https://www.alphavantage.co/query?function=${func}&symbol=${symbol}&apikey=${key}`;
            }

            Main();
        }

        function populateTable(){
            let type1 = "Revenue Growth";
            let target1 = 10;
            let actual1 = 5;
            let margin1 = (actual1 - target1)/target1;
            document.getElementById("type1").innerHTML = type1;
            document.getElementById("target1").innerHTML = target1;
            document.getElementById("actual1").innerHTML = actual1;
            document.getElementById("margin1").innerHTML = (margin1*100) + "%";
            if(target1 <= actual1){
                document.getElementById("row1").classList.add("success");
            }
            else{
                document.getElementById("row1").classList.add("danger");
            }

            let type2 = "Earnings Growth";
            let target2 = 3;
            let actual2 = 6;
            let margin2 = (actual2 - target2)/target2;
            document.getElementById("type2").innerHTML = type2;
            document.getElementById("target2").innerHTML = target2;
            document.getElementById("actual2").innerHTML = actual2;
            document.getElementById("margin2").innerHTML = (margin2*100) + "%";
            if(target2 <= actual2){
                document.getElementById("row2").classList.add("success");
            }
            else{
                document.getElementById("row2").classList.add("danger");
            }

            let type3 = "New Stores";
            let target3 = 10;
            let actual3 = 10;
            let margin3 = (actual3 - target3)/target3;
            document.getElementById("type3").innerHTML = type3;
            document.getElementById("target3").innerHTML = target3;
            document.getElementById("actual3").innerHTML = actual3;
            document.getElementById("margin3").innerHTML = (margin3*100) + "%";
            if(target3 <= actual3){
                document.getElementById("row3").classList.add("success");
            }
            else{
                document.getElementById("row3").classList.add("danger");
            }
        }

        function pageLoad(){
            changeInterval("daily");
            populateTable();
        }



    </script>

    <div class="container-fluid">
        <div class="row">
            <h1 class="text-center">Pitch Accuracy Analysis</h1>
            <div class="col-lg-6">
                <h2 class="text-center">Price Chart</h2>
                <p class="text-center">
                    <button type="button" onclick="changeInterval('1min')">1 minute</button>
                    <button type="button" onclick="changeInterval('5min')">5 minutes</button>
                    <button type="button" onclick="changeInterval('15min')">15 minutes</button>
                    <button type="button" onclick="changeInterval('30min')">30 minutes</button>
                    <button type="button" onclick="changeInterval('60min')">1 hour</button>
                    <button type="button" onclick="changeInterval('daily')">Daily</button>
                    <button type="button" onclick="changeInterval('weekly')">Weekly</button>
                    <button type="button" onclick="changeInterval('monthly')">Monthly</button>
                </p>
            </div>
            <div class="col-lg-6"></div>
        </div>
        <div class="row">
            <div class="col-lg-6">
                <canvas id="priceChart" height="400" width="700"></canvas>
            </div>
            <div class="col-lg-6">
                <h2>Target Metrics</h2>
                <p>The following table summarizes the target metrics within the stock pitch (Target column) and tracks them against current reportings and predictions (Actual column).
                    The Margin Column displays the percent difference between the Target Metric and its reported outcome. <b>**Current Numbers are Placeholders**</b>
                </p>
                <table class="table">
                <thead>
                    <tr>
                    <th>Type</th>
                    <th>Target</th>
                    <th>Actual</th>
                    <th>Margin</th>
                    </tr>
                </thead>
                <tbody>
                    <tr id="row1">
                    <td id="type1"></td>
                    <td id="target1"></td>
                    <td id="actual1"></td>
                    <td id="margin1"></td>
                    </tr>      
                    <tr id="row2">
                    <td id="type2"></td>
                    <td id="target2"></td>
                    <td id="actual2"></td>
                    <td id="margin2"></td>
                    </tr>
                    <tr id="row3">
                    <td id="type3"></td>
                    <td id="target3"></td>
                    <td id="actual3"></td>
                    <td id="margin3"></td>
                    </tr>
                </tbody>
                </table>
            </div>
    </div>

</body>

</html>
